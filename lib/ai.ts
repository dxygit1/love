
const AI_CONFIG = {
    apiKey: 'sk-a60892f196f306697fbe06c2def38d9a',
    baseUrl: 'https://apis.iflow.cn/v1',
    model: 'tstars2.0'
};

export interface XiaohongshuResult {
    title: string;
    content: string;
}

export async function generateXiaohongshuCopy(type: 'mental-age' | 'love-quiz' | 'does-he-like-me' | 'do-i-like-her', data: any): Promise<XiaohongshuResult> {
    let prompt = "";

    if (type === 'mental-age') {
        prompt = `
ä½ æ˜¯ä¸€ä¸ªå°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹å¿ƒç†å¹´é¾„æµ‹è¯•ç»“æœï¼Œå†™ä¸€ç¯‡å¸å¼•äººçš„å°çº¢ä¹¦ç¬”è®°ã€‚

**æµ‹è¯•æ•°æ®ï¼š**
- çœŸå®å¹´é¾„ï¼š${data.realAge} å²
- æµ‹å‡ºçš„å¿ƒç†å¹´é¾„ï¼š${data.mentalAge} å²
- è¯„ä»·/ç§°å·ï¼š${data.title}
- æ€§æ ¼ä¾§å†™ï¼š${data.description}

**è¦æ±‚ï¼š**
1. **æ ‡é¢˜**ï¼š
   - **ç»å¯¹ç¦æ­¢**åœ¨æ ‡é¢˜ä¸­å‡ºç°ä»»ä½•å…·ä½“çš„æ•°å­—ï¼ˆå¦‚â€œ18å²â€ã€â€œ40å²â€ï¼‰ã€‚
   - å¿…é¡»éå¸¸å¸å¼•çœ¼çƒï¼Œåˆ¶é€ å·¨å¤§çš„åå·®æ„Ÿã€æ‚¬å¿µæˆ–æ‰å¿ƒæ„Ÿï¼ˆâ€œæ ‡é¢˜å…šâ€ï¼‰ã€‚
   - å¿…é¡»å¸¦æœ‰emojiã€‚
   - å­—æ•°æ§åˆ¶åœ¨20å­—ä»¥å†…ã€‚
   - é”™è¯¯ç¤ºä¾‹ï¼šâ€œæˆ‘æµ‹å‡ºå¿ƒç†å¹´é¾„18å²â€ï¼ˆå¤ªç›´ç™½ï¼‰ã€‚
   - æ­£ç¡®ç¤ºä¾‹ï¼šâ€œæµ‹å®Œå´©æºƒäº†...å‡†åˆ°ä¸æ•¢å‘æœ‹å‹åœˆğŸ˜­â€ã€â€œå¤©å‘ï¼æˆ‘çš„å¿ƒç†å¹´é¾„ç«Ÿç„¶...ğŸ˜±â€ã€‚

2. **æ­£æ–‡**ï¼š
   - è¯­æ°”è¦äººæ€§åŒ–ã€çœŸå®ã€ç•¥å¸¦ä¸€ç‚¹â€œæ–‡é›…â€æˆ–â€œæ‰å¿ƒâ€ï¼Œä¸è¦å¤ªåƒæœºå™¨ç”Ÿæˆçš„ã€‚
   - é‡ç‚¹å¯¹æ¯”â€œçœŸå®å¹´é¾„â€å’Œâ€œå¿ƒç†å¹´é¾„â€çš„åå·®ã€‚
   - åŒ…å«é€‚å½“çš„emojiã€‚
   - ä¸è¦å¤§æ®µè¯´æ•™ï¼Œè¦åƒæ˜¯ç”¨æˆ·è‡ªå·±æµ‹å®Œåçš„çœŸå®æ„Ÿæ…¨ã€‚
   - **ä¸è¦**åŒ…å«ä»»ä½•è¿è§„ã€æ•æ„Ÿè¯æ±‡ï¼Œç¡®ä¿å®‰å…¨åˆè§„ã€‚
   - ç¯‡å¹…è¦**çŸ­å°ç²¾æ‚**ï¼Œæ§åˆ¶åœ¨80-120å­—ä¹‹é—´ï¼Œä¸è¦åºŸè¯ã€‚
   - ç»“å°¾å¯ä»¥å¼•å¯¼äº’åŠ¨ï¼ˆå¦‚â€œä½ ä»¬æµ‹å‡ºæ¥æ˜¯å¤šå°‘ï¼Ÿâ€ï¼‰ã€‚

è¯·ç›´æ¥è¿”å›JSONæ ¼å¼ï¼ŒåŒ…å« title å’Œ content ä¸¤ä¸ªå­—æ®µã€‚
`;
    } else {
        // Love Quiz / Relationship types
        prompt = `
ä½ æ˜¯ä¸€ä¸ªå°çº¢ä¹¦æƒ…æ„Ÿæ–‡æ¡ˆä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹æ‹çˆ±/æƒ…æ„Ÿæµ‹è¯•ç»“æœï¼Œå†™ä¸€ç¯‡å”¯ç¾ã€èµ°å¿ƒçš„å°çº¢ä¹¦ç¬”è®°ã€‚

**æµ‹è¯•æ•°æ®ï¼š**
- æµ‹è¯•ç±»å‹ï¼š${data.quizName}
- å¾—åˆ†ï¼š${data.score} åˆ† (æ»¡åˆ†100)
- è¯„ä»·/ç»“æœï¼š${data.resultTitle}
- å¯¹æ–¹åå­—/ä»£å·ï¼š${data.partnerName || "TA"}

**è¦æ±‚ï¼š**
1. **æ ‡é¢˜**ï¼š
   - **ç»å¯¹ç¦æ­¢**åœ¨æ ‡é¢˜ä¸­å‡ºç°ä»»ä½•å…·ä½“çš„æ•°å­—ï¼ˆå¦‚â€œ85åˆ†â€ã€â€œ100åˆ†â€ï¼‰ã€‚
   - é£æ ¼è¦æ–‡è‰ºã€æ¸…é†’ã€æ‰å¿ƒæˆ–æåº¦ç”œèœœï¼Œå¸å¼•ç‚¹å‡»ã€‚
   - å¿…é¡»å¸¦æœ‰emojiã€‚
   - å­—æ•°20å­—ä»¥å†…ã€‚
   - é”™è¯¯ç¤ºä¾‹ï¼šâ€œæˆ‘å’ŒTAçš„åŒ¹é…åº¦85åˆ†â€ï¼ˆå¤ªæ¯ç‡¥ï¼‰ã€‚
   - æ­£ç¡®ç¤ºä¾‹ï¼šâ€œåŸæ¥ï¼Œè¿™å°±æ˜¯å‘½ä¸­æ³¨å®šçš„æ„Ÿè§‰...ğŸ’”â€ã€â€œæµ‹å®Œæ‰æ‡‚ï¼šæœ‰äº›äººæ³¨å®šåªæ˜¯è¿‡å®¢ğŸ‘‹â€ã€â€œå‡†å“­äº†ï¼è¿™è¿˜æ˜¯æˆ‘è®¤è¯†çš„TAå—ï¼ŸğŸ˜±â€ã€‚

2. **æ­£æ–‡**ï¼š
   - å‚è€ƒé£æ ¼ï¼šâ€œè¿™ä»½æ·¡æ·¡çš„å–œæ¬¢ï¼Œåˆ°åº•è¯¥ä¸è¯¥å†åšæŒ... è—åœ¨å¿ƒåº•çš„æš§æ˜§ï¼Œç»ˆäºæœ‰ç­”æ¡ˆäº†...â€
   - è¯­æ°”è¦æ¸©æŸ”ã€ç»†è…»ã€è§¦åŠ¨äººå¿ƒã€‚
   - **ç»å¯¹ç¦æ­¢**å‡ºç°ä»»ä½•å…·ä½“åˆ†æ•°ã€æ•°å­—ã€ç™¾åˆ†æ¯”ï¼ˆå¦‚"85åˆ†"ã€"100åˆ†"ã€"95%"ï¼‰ã€‚
   - ç”¨æ–‡å­—æè¿°æ„Ÿæƒ…ç¨‹åº¦ï¼Œä¾‹å¦‚"æ·±æ·±çš„çˆ±æ„"ã€"æ·¡æ·¡çš„å–œæ¬¢"ï¼Œä¸è¦æåŠä»»ä½•æ•°å­—ã€‚
   - **ç»å¯¹ç¦æ­¢**å‡ºç°â€œä»–â€ã€â€œå¥¹â€ã€â€œç”·â€ã€â€œå¥³â€ç­‰æ€§åˆ«ç‰¹å®šè¯æ±‡ã€‚
   - **å¿…é¡»**ç»Ÿä¸€ä½¿ç”¨â€œTAâ€ã€â€œå¯¹æ–¹â€æˆ–â€œé‚£ä¸ªäººâ€æ¥æŒ‡ä»£å¯¹è±¡ã€‚
   - å³ä½¿æµ‹è¯•é¢˜ç›®æˆ–ç»“æœä¸­åŒ…å«æ€§åˆ«è¯æ±‡ï¼Œä½ åœ¨å†™æ–‡æ¡ˆæ—¶ä¹Ÿ**å¿…é¡»è‡ªåŠ¨æ›¿æ¢**ä¸ºä¸­æ€§è¯ã€‚
   - ç¯‡å¹…è¦**çŸ­å°ç²¾æ‚**ï¼Œæ§åˆ¶åœ¨80-120å­—ä¹‹é—´ï¼Œé€‚åˆå¿«é€Ÿé˜…è¯»ã€‚

è¯·ç›´æ¥è¿”å›JSONæ ¼å¼ï¼ŒåŒ…å« title å’Œ content ä¸¤ä¸ªå­—æ®µã€‚
`;
    }

    try {
        const response = await fetch(`${AI_CONFIG.baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${AI_CONFIG.apiKey}`
            },
            body: JSON.stringify({
                model: AI_CONFIG.model,
                messages: [
                    { role: "system", content: "You are a helpful assistant that generates social media content. Always respond in valid JSON format with 'title' and 'content' keys." },
                    { role: "user", content: prompt }
                ],
                temperature: 0.7
            })
        });

        const json = await response.json();
        const contentText = json.choices[0].message.content;

        // Try to parse JSON from the response text (it might be wrapped in markdown code blocks)
        try {
            const cleanJson = contentText.replace(/```json/g, '').replace(/```/g, '').trim();
            return JSON.parse(cleanJson);
        } catch (e) {
            // Fallback if not valid JSON
            return {
                title: "æ–‡æ¡ˆç”ŸæˆæˆåŠŸ",
                content: contentText
            };
        }

    } catch (error) {
        console.error("AI Generation Error:", error);
        throw new Error("Failed to generate content");
    }
}
